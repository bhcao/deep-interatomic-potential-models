name: Package Publishing

on:
  release:
    types: [published]

jobs:
  publish-new-dipm-release:
    runs-on: ubuntu-latest

    container:
       image: python:3.12-slim-bullseye

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup
        run: apt-get update && apt-get install -y coreutils

      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Build and publish dipm
        run: |
          uv build
          uv publish --token ${{secrets.PYPI_API_TOKEN}} --publish-url https://test.pypi.org/legacy/

      - name: Build and publish dipm-cvt
        working-directory: dipm-conversion-tool
        run: |
          uv build
          uv publish --token ${{secrets.PYPI_API_TOKEN}} --publish-url https://test.pypi.org/legacy/
